{% extends "base.html" %}

{% block title %}Analytics - {{ child.name }}{% endblock %}

{% block content %}
<!-- Hidden data containers -->
<div style="display: none;">
    <div id="state-data">{{ state_distribution | tojson | safe }}</div>
    <div id="brain-states-data">{{ brain_states | tojson | safe }}</div>
    <div id="mood-data">{{ mood_data | tojson | safe }}</div>
</div>

<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <h2><i class="fas fa-chart-line"></i> Analytics for {{ child.name }}</h2>
            <a href="{{ url_for('parent.dashboard') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left"></i> Back to Dashboard
            </a>
        </div>
    </div>
</div>

<div class="row">
    <!-- Brain State Distribution -->
    <div class="col-md-6 mb-4">
        <div class="card shadow-sm">
            <div class="card-body">
                <h5 class="card-title"><i class="fas fa-brain"></i> Brain State Distribution (Last 7 Days)</h5>
                {% if state_distribution %}
                <div style="position: relative; height: 300px;">
                    <canvas id="stateChart"></canvas>
                </div>
                {% else %}
                <p class="text-muted text-center py-4">No brain state data available yet.</p>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Mood Distribution -->
    <div class="col-md-6 mb-4">
        <div class="card shadow-sm">
            <div class="card-body">
                <h5 class="card-title"><i class="fas fa-smile"></i> Mood Distribution (Last 7 Days)</h5>
                {% if mood_data %}
                <div style="position: relative; height: 300px;">
                    <canvas id="moodChart"></canvas>
                </div>
                {% else %}
                <p class="text-muted text-center py-4">No mood data available yet.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Activity Statistics -->
    <div class="col-12 mb-4">
        <div class="card shadow-sm">
            <div class="card-body">
                <h5 class="card-title"><i class="fas fa-gamepad"></i> Activity Performance</h5>
                {% if activity_stats %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Activity Type</th>
                                <th>Count</th>
                                <th>Average Completion Rate</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for stat in activity_stats %}
                            <tr>
                                <td><i class="fas fa-play-circle"></i> {{ stat.type }}</td>
                                <td><span class="badge bg-primary">{{ stat.count }}</span></td>
                                <td>
                                    <div class="progress" style="height: 25px;">
                                        <div class="progress-bar bg-success" role="progressbar" 
                                             data-width="{{ stat.avg_completion }}"
                                             aria-valuenow="{{ stat.avg_completion }}" 
                                             aria-valuemin="0" 
                                             aria-valuemax="100">
                                            {{ stat.avg_completion }}%
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted text-center py-4">No activity data available yet.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Quiz Performance Section -->
{% if quiz_stats %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow-sm">
            <div class="card-body">
                <h5 class="card-title"><i class="fas fa-graduation-cap"></i> Quiz Performance</h5>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Quiz Name</th>
                                <th>Attempts</th>
                                <th>Average Score</th>
                                <th>Best Score</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for stat in quiz_stats %}
                            <tr>
                                <td><i class="fas fa-book"></i> {{ stat.title }}</td>
                                <td><span class="badge bg-info">{{ stat.attempts }}</span></td>
                                <td>
                                    <div class="progress" style="height: 25px; min-width: 100px;">
                                        <div class="progress-bar bg-primary" role="progressbar" 
                                             data-width="{{ stat.avg_score }}">
                                            {{ "%.1f"|format(stat.avg_score) }}%
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <div class="progress" style="height: 25px; min-width: 100px;">
                                        <div class="progress-bar bg-success" role="progressbar" 
                                             data-width="{{ stat.best_score }}">
                                            {{ "%.1f"|format(stat.best_score) }}%
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}


<!-- Summary Cards -->
<div class="row">
    <div class="col-md-4 mb-4">
        <div class="card shadow-sm text-center">
            <div class="card-body">
                <h6 class="text-muted">Total Brain State Records</h6>
                <h2 class="text-primary">{{ state_distribution.values()|sum|default(0) }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-4 mb-4">
        <div class="card shadow-sm text-center">
            <div class="card-body">
                <h6 class="text-muted">Mood Logs</h6>
                <h2 class="text-success">{{ mood_data|length }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-4 mb-4">
        <div class="card shadow-sm text-center">
            <div class="card-body">
                <h6 class="text-muted">Activities Completed</h6>
                <h2 class="text-info">{{ activity_stats|map(attribute='count')|sum|default(0) }}</h2>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Set progress bar widths
    const progressBars = document.querySelectorAll('.progress-bar[data-width]');
    progressBars.forEach(bar => {
        const width = bar.getAttribute('data-width');
        bar.style.width = width + '%';
    });
    
    // Get data from hidden divs
    const stateDataEl = document.getElementById('state-data');
    const brainStatesEl = document.getElementById('brain-states-data');
    const moodDataEl = document.getElementById('mood-data');
    
    // Brain State Distribution Chart
    if (stateDataEl && stateDataEl.textContent.trim() !== '{}' && stateDataEl.textContent.trim() !== '') {
        const stateDataRaw = JSON.parse(stateDataEl.textContent);
        const brainStatesRaw = JSON.parse(brainStatesEl.textContent);
        
        const stateColors = Object.keys(stateDataRaw).map(state => {
            return brainStatesRaw[state] ? brainStatesRaw[state].color : '#6c757d';
        });
        
        const stateLabels = Object.keys(stateDataRaw).map(state => {
            return brainStatesRaw[state] ? brainStatesRaw[state].label : state;
        });
        
        const stateChart = document.getElementById('stateChart');
        if (stateChart) {
            new Chart(stateChart, {
                type: 'doughnut',
                data: {
                    labels: stateLabels,
                    datasets: [{
                        data: Object.values(stateDataRaw),
                        backgroundColor: stateColors,
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return label + ': ' + value + ' (' + percentage + '%)';
                                }
                            }
                        }
                    }
                }
            });
        }
    }
    
    // Mood Distribution Bar Chart
    if (moodDataEl && moodDataEl.textContent.trim() !== '[]' && moodDataEl.textContent.trim() !== '') {
        const moodDataRaw = JSON.parse(moodDataEl.textContent);
        
        // Count moods by type
        const moodCounts = {
            happy: 0,
            calm: 0,
            anxious: 0,
            upset: 0
        };
        
        moodDataRaw.forEach(m => {
            if (moodCounts.hasOwnProperty(m.mood)) {
                moodCounts[m.mood]++;
            }
        });
        
        const moodChart = document.getElementById('moodChart');
        if (moodChart) {
            new Chart(moodChart, {
                type: 'bar',
                data: {
                    labels: ['ðŸ˜Š Happy', 'ðŸ˜Œ Calm', 'ðŸ˜° Anxious', 'ðŸ˜¢ Upset'],
                    datasets: [{
                        label: 'Number of Times',
                        data: [moodCounts.happy, moodCounts.calm, moodCounts.anxious, moodCounts.upset],
                        backgroundColor: ['#4CAF50', '#2196F3', '#FF9800', '#F44336'],
                        borderWidth: 0,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1,
                                precision: 0
                            },
                            title: {
                                display: true,
                                text: 'Number of Times Logged'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Mood Type'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'Logged ' + context.parsed.y + ' time(s)';
                                }
                            }
                        }
                    }
                }
            });
        }
    }
});
</script>
{% endblock %}
